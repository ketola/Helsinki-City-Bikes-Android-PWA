<html>
  <head>
    <title>Helsinki City Bikes</title>
    <script language>
    if ('serviceWorker' in navigator) {
      //window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
          // Registration was successful
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          // registration failed :(
          console.log('ServiceWorker registration failed: ', err);
        });
    //  });
    }

    function initPushMessages() {
      // Are Notifications supported in the service worker?
      if (!('showNotification' in ServiceWorkerRegistration.prototype)) {
        console.warn('Notifications aren\'t supported.');
        return;
      }

      // Check the current Notification permission.
      // If its denied, it's a permanent block until the
      // user changes the permission
      if (Notification.permission === 'denied') {
        console.warn('The user has blocked notifications.');
        return;
      }

      // Check if push messaging is supported
      if (!('PushManager' in window)) {
        console.warn('Push messaging isn\'t supported.');
        return;
      }

      // We need the service worker registration to check for a subscription
      navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
        // Do we already have a push message subscription?
        serviceWorkerRegistration.pushManager.getSubscription()
          .then(function(subscription) {
            if (!subscription) {
              // We aren't subscribed to push, so set UI
              // to allow the user to enable push
              console.warn('Client has not subscribed to push messaging');
              return;
            }

            // Keep your server in sync with the latest subscriptionId
            sendSubscriptionToServer(subscription);
            console.log('The client is ready to receive messages');
          })
          .catch(function(err) {
            console.warn('Error during getSubscription()', err);
          });
      });
    }

    function subscribeForPush() {
      console.log('Subscribe for push');
      navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
        serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly: true})
          .then(function(subscription) {
              return sendSubscriptionToServer(subscription);
          })
          .catch(function(e) {
            if (Notification.permission === 'denied') {
              // The user denied the notification permission which
              // means we failed to subscribe and the user will need
              // to manually change the notification permission to
              // subscribe to push messages
              console.warn('Permission for Notifications was denied');
            } else {
              // A problem occurred with the subscription; common reasons
              // include network errors, and lacking gcm_sender_id and/or
              // gcm_user_visible_only in the manifest.
              console.error('Unable to subscribe to push.', e);
            }
          });
      });
    }

    function sendSubscriptionToServer(subscription){
      console.log('send subscription to server ' + JSON.stringify(subscription))
    }

    initPushMessages();
    subscribeForPush();


    </script>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="public/css/style.css">
  </head>
  <body>
    <div class="js-app"></div>
    <script src="/js/bundle.js"></script>
    <script>


    </script>
  </body>
</html>
